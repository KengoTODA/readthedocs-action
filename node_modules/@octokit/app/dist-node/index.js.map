{"version":3,"file":"index.js","sources":["../dist-src/get-cache.js","../dist-src/get-signed-json-web-token.js","../dist-src/get-installation-access-token.js","../dist-src/version.js","../dist-src/index.js"],"sourcesContent":["// https://github.com/isaacs/node-lru-cache#readme\nimport LRU from \"lru-cache\";\nexport function getCache() {\n    return new LRU({\n        // cache max. 15000 tokens, that will use less than 10mb memory\n        max: 15000,\n        // Cache for 59 minutes (1 minute less than GitHub expiry)\n        maxAge: 1000 * 60 * 59\n    });\n}\n","import jsonwebtoken from \"jsonwebtoken\";\nexport function getSignedJsonWebToken({ id, privateKey }) {\n    const now = Math.floor(Date.now() / 1000);\n    const payload = {\n        iat: now,\n        exp: now + 60 * 10 - 30,\n        iss: id\n    };\n    const token = jsonwebtoken.sign(payload, privateKey, { algorithm: \"RS256\" });\n    return token;\n}\n","import { getSignedJsonWebToken } from \"./get-signed-json-web-token\";\n// https://developer.github.com/v3/apps/#create-a-new-installation-token\nexport function getInstallationAccessToken(state, { installationId, repositoryIds, permissions }) {\n    const token = state.cache.get(installationId);\n    if (token) {\n        return Promise.resolve(token);\n    }\n    return state\n        .request({\n        method: \"POST\",\n        url: \"/app/installations/:installation_id/access_tokens\",\n        installation_id: installationId,\n        headers: {\n            accept: \"application/vnd.github.machine-man-preview+json\",\n            // TODO: cache the installation token if it's been less than 60 minutes\n            authorization: `bearer ${getSignedJsonWebToken(state)}`\n        },\n        repository_ids: repositoryIds,\n        permissions\n    })\n        .then(response => {\n        state.cache.set(installationId, response.data.token);\n        return response.data.token;\n    });\n}\n","export const VERSION = \"4.2.0\";\n","import { request } from \"@octokit/request\";\nimport { getCache } from \"./get-cache\";\nimport { getInstallationAccessToken } from \"./get-installation-access-token\";\nimport { getSignedJsonWebToken } from \"./get-signed-json-web-token\";\nimport { VERSION } from \"./version\";\nexport class App {\n    constructor({ id, privateKey, baseUrl, cache }) {\n        const state = {\n            id,\n            privateKey,\n            request: baseUrl ? request.defaults({ baseUrl }) : request,\n            cache: cache || getCache()\n        };\n        this.getSignedJsonWebToken = getSignedJsonWebToken.bind(null, state);\n        this.getInstallationAccessToken = getInstallationAccessToken.bind(null, state);\n    }\n}\nApp.VERSION = VERSION;\n"],"names":["getCache","LRU","max","maxAge","getSignedJsonWebToken","id","privateKey","now","Math","floor","Date","payload","iat","exp","iss","token","jsonwebtoken","sign","algorithm","getInstallationAccessToken","state","installationId","repositoryIds","permissions","cache","get","Promise","resolve","request","method","url","installation_id","headers","accept","authorization","repository_ids","then","response","set","data","VERSION","App","constructor","baseUrl","defaults","bind"],"mappings":";;;;;;;;;;AAAA;AAEO,SAASA,QAAT,GAAoB;AACvB,SAAO,IAAIC,GAAJ,CAAQ;AACX;AACAC,IAAAA,GAAG,EAAE,KAFM;AAGX;AACAC,IAAAA,MAAM,EAAE,OAAO,EAAP,GAAY;AAJT,GAAR,CAAP;AAMH;;ACRM,SAASC,qBAAT,CAA+B;AAAEC,EAAAA,EAAF;AAAMC,EAAAA;AAAN,CAA/B,EAAmD;AACtD,QAAMC,GAAG,GAAGC,IAAI,CAACC,KAAL,CAAWC,IAAI,CAACH,GAAL,KAAa,IAAxB,CAAZ;AACA,QAAMI,OAAO,GAAG;AACZC,IAAAA,GAAG,EAAEL,GADO;AAEZM,IAAAA,GAAG,EAAEN,GAAG,GAAG,KAAK,EAAX,GAAgB,EAFT;AAGZO,IAAAA,GAAG,EAAET;AAHO,GAAhB;AAKA,QAAMU,KAAK,GAAGC,YAAY,CAACC,IAAb,CAAkBN,OAAlB,EAA2BL,UAA3B,EAAuC;AAAEY,IAAAA,SAAS,EAAE;AAAb,GAAvC,CAAd;AACA,SAAOH,KAAP;AACH;;ACRM,SAASI,0BAAT,CAAoCC,KAApC,EAA2C;AAAEC,EAAAA,cAAF;AAAkBC,EAAAA,aAAlB;AAAiCC,EAAAA;AAAjC,CAA3C,EAA2F;AAC9F,QAAMR,KAAK,GAAGK,KAAK,CAACI,KAAN,CAAYC,GAAZ,CAAgBJ,cAAhB,CAAd;;AACA,MAAIN,KAAJ,EAAW;AACP,WAAOW,OAAO,CAACC,OAAR,CAAgBZ,KAAhB,CAAP;AACH;;AACD,SAAOK,KAAK,CACPQ,OADE,CACM;AACTC,IAAAA,MAAM,EAAE,MADC;AAETC,IAAAA,GAAG,EAAE,mDAFI;AAGTC,IAAAA,eAAe,EAAEV,cAHR;AAITW,IAAAA,OAAO,EAAE;AACLC,MAAAA,MAAM,EAAE,iDADH;AAEL;AACAC,MAAAA,aAAa,EAAG,UAAS9B,qBAAqB,CAACgB,KAAD,CAAQ;AAHjD,KAJA;AASTe,IAAAA,cAAc,EAAEb,aATP;AAUTC,IAAAA;AAVS,GADN,EAaFa,IAbE,CAaGC,QAAQ,IAAI;AAClBjB,IAAAA,KAAK,CAACI,KAAN,CAAYc,GAAZ,CAAgBjB,cAAhB,EAAgCgB,QAAQ,CAACE,IAAT,CAAcxB,KAA9C;AACA,WAAOsB,QAAQ,CAACE,IAAT,CAAcxB,KAArB;AACH,GAhBM,CAAP;AAiBH;;ACxBM,MAAMyB,OAAO,GAAG,mBAAhB;;ACKA,MAAMC,GAAN,CAAU;AACbC,EAAAA,WAAW,CAAC;AAAErC,IAAAA,EAAF;AAAMC,IAAAA,UAAN;AAAkBqC,IAAAA,OAAlB;AAA2BnB,IAAAA;AAA3B,GAAD,EAAqC;AAC5C,UAAMJ,KAAK,GAAG;AACVf,MAAAA,EADU;AAEVC,MAAAA,UAFU;AAGVsB,MAAAA,OAAO,EAAEe,OAAO,GAAGf,eAAO,CAACgB,QAAR,CAAiB;AAAED,QAAAA;AAAF,OAAjB,CAAH,GAAmCf,eAHzC;AAIVJ,MAAAA,KAAK,EAAEA,KAAK,IAAIxB,QAAQ;AAJd,KAAd;AAMA,SAAKI,qBAAL,GAA6BA,qBAAqB,CAACyC,IAAtB,CAA2B,IAA3B,EAAiCzB,KAAjC,CAA7B;AACA,SAAKD,0BAAL,GAAkCA,0BAA0B,CAAC0B,IAA3B,CAAgC,IAAhC,EAAsCzB,KAAtC,CAAlC;AACH;;AAVY;AAYjBqB,GAAG,CAACD,OAAJ,GAAcA,OAAd;;;;"}